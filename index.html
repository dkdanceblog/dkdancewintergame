<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ДК ДАНС Игра Хлопья Летят Наверх</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
      color: #fff;
    }

    #wrap { position: relative; }

    canvas {
      display: block;
      background: #000;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
      transition: filter .3s ease, transform .3s ease;
      touch-action: none;
    }

    #game.blurred {
      filter: blur(6px) brightness(.6);
      transform: scale(1.02);
    }

    #hud {
      position: absolute;
      inset: 0;
      pointer-events: none;
      padding: 20px 10px 8px 10px; /* чуть ниже HUD */
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      text-shadow: 0 0 6px #000;
    }

    #center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      white-space: pre-line;
      text-align: center;
      pointer-events: none;
      text-shadow: 0 0 8px #000;
      opacity: 1;
      font-size: 13px;
      transition: opacity .6s ease;
    }

    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    #overlay.show { display: flex; animation: fadeUp .35s ease; }

    #card { max-width: 90%; padding: 15px; }

    #title { font-size: 24px; margin-bottom: 8px; font-weight: 600; }
    #line1 { font-size: 16px; margin: 4px 0; }
    #line2 { font-size: 14px; margin: 4px 0 12px; }

    #hint { font-size: 12px; opacity: .7; }

    @keyframes fadeUp {
      from { opacity:0; transform: translateY(14px); }
      to   { opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
<div id="wrap">
  <canvas id="game" width="360" height="640"></canvas>

  <div id="hud">
    <div id="score">Счёт: 0</div>
    <div id="lives">Жизни: 3</div>
  </div>

  <div id="center"></div>

  <div id="overlay">
    <div id="card">
      <div id="title"></div>
      <div id="line1"></div>
      <div id="line2"></div>
      <div id="hint">Нажми, чтобы сыграть ещё раз</div>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;

const scoreEl  = document.getElementById("score");
const livesEl  = document.getElementById("lives");
const centerEl = document.getElementById("center");

const overlay = document.getElementById("overlay");
const titleEl = document.getElementById("title");
const line1El = document.getElementById("line1");
const line2El = document.getElementById("line2");

// ---------------- ИГРА ----------------
let score = 0;
let lives = 3;
const WIN_SCORE = 100;

let gameOver = false;
let lastTime = 0;
let spawnTimer = 0;
let spawnInterval = 1.05;

const flakes = [];
let isWin = false;
let celebrationFlakes = [];

let bobTime = 0; // покачивание Федука

// ---------------- СПРАЙТЫ ----------------
const bgImg    = new Image();
const fedukImg = new Image();
const snowImg  = new Image();
const flakeImg = new Image();

bgImg.src    = "assets/bg.png";
fedukImg.src = "assets/feduk.png";
snowImg.src  = "assets/snow.png";
flakeImg.src = "assets/flake.png";

function loaded(img) {
  return img.complete && img.naturalWidth > 0;
}

// ---------------- МУЗЫКА ----------------
const music = new Audio("assets/music.mp3");
music.loop = true;
music.volume = 0.35;
let musicStarted = false;

function startMusic() {
  if (musicStarted) return;
  musicStarted = true;
  music.muted = false;
  music.play().catch(()=>{});
}

document.addEventListener("click", startMusic, { once:true });
document.addEventListener("touchstart", startMusic, { once:true });

// ---------------- ПОДСКАЗКА ----------------
let hintTimeout = null;
function showCenterHint() {
  if (hintTimeout) clearTimeout(hintTimeout);
  centerEl.style.opacity = 1;
  centerEl.textContent =
"Лови белые хлопья!\nНе дай им улететь мимо.\nДвигай ← → или води пальцем.";

  hintTimeout = setTimeout(() => {
    centerEl.style.opacity = 0;
  }, 10000);
}

// ---------------- ИГРОК ----------------
const player = {
  x: W/2 - 35,
  y: H * 0.18,
  w: 70,
  h: 110,
  speed: 450
};

function drawPlayer() {
  bobTime += 0.04;
  const bobY = Math.sin(bobTime) * 2;
  const bobX = Math.sin(bobTime * 0.7) * 1.2;

  const drawX = player.x + bobX;
  const drawY = player.y + bobY;

  if (loaded(fedukImg)) {
    ctx.drawImage(fedukImg, drawX, drawY, player.w, player.h);
  } else {
    ctx.fillStyle = "#f55";
    ctx.fillRect(drawX, drawY, player.w, player.h);
  }
}

// ---------------- СНЕЖИНКИ ----------------
function spawnFlake() {
  flakes.push({
    x: Math.random() * (W - 40) + 20,
    y: H + 20,
    r: 12,
    speed: Math.random() * 110 + 100,

    // новые поля — живость
    offset: Math.random() * Math.PI * 2,
    amp: 4 + Math.random() * 3,
    wobbleSpeed: 1 + Math.random() * 1.5
  });
}

function drawFlakes(list = flakes) {
  for (const f of list) {
    if (loaded(flakeImg)) {
      ctx.drawImage(flakeImg, f.x - f.r, f.y - f.r, f.r*2, f.r*2);
    } else {
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
      ctx.fill();
    }
  }
}

// финальная метель
function createCelebrationFlakes() {
  celebrationFlakes = [];
  for (let i = 0; i < 120; i++) {
    celebrationFlakes.push({
      x: Math.random() * W,
      y: Math.random() * H,
      r: 10 + Math.random()*4,
      speed: 60 + Math.random()*60
    });
  }
}

function updateCelebration(dt) {
  for (const f of celebrationFlakes) {
    f.y -= f.speed * dt;
    if (f.y + f.r < -20) {
      f.y = H + 20;
      f.x = Math.random()*W;
    }
  }
}

// ---------------- ФОН ----------------
function drawBG() {
  if (loaded(bgImg)) ctx.drawImage(bgImg, 0, 0, W, H);
  else {
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,W,H);
  }

  if (loaded(snowImg)) {
    const h = H * 0.25;
    ctx.drawImage(snowImg, 0, H-h, W, h);
  }
}

// ---------------- HUD ----------------
function updateHUD() {
  scoreEl.textContent = "Счёт: " + score;
  livesEl.textContent = "Жизни: " + lives;
}

// ---------------- ОВЕРЛЕЙ ----------------
function showOverlay(win) {
  isWin = win;
  canvas.classList.add("blurred");
  overlay.classList.add("show");

  if (win) {
    titleEl.textContent = "Победа!";
    line1El.textContent = `Ты поймал ${score} хлопьев`;
    line2El.textContent = "Всюду магия и свет ✨";
    createCelebrationFlakes();
  } else {
    titleEl.textContent = "Игра окончена";
    line1El.textContent = `Ты поймал ${score} хлопьев`;
    line2El.textContent = "Падают хлопья, и с ними ты ❄️";
  }
}

function resetGame() {
  score = 0;
  lives = 3;
  flakes.length = 0;
  celebrationFlakes.length = 0;
  spawnInterval = 1.05;
  spawnTimer = 0;
  gameOver = false;
  isWin = false;

  player.x = W/2 - player.w/2;

  canvas.classList.remove("blurred");
  overlay.classList.remove("show");

  updateHUD();
  showCenterHint();
  startMusic();
}

// ---------------- УПРАВЛЕНИЕ ----------------
const keys = { left:false, right:false };

window.addEventListener("keydown", e=>{
  if (e.key==="ArrowLeft" || e.key==="a")  keys.left=true;
  if (e.key==="ArrowRight"|| e.key==="d") keys.right=true;
  startMusic();
});
window.addEventListener("keyup", e=>{
  if (e.key==="ArrowLeft" || e.key==="a")  keys.left=false;
  if (e.key==="ArrowRight"|| e.key==="d") keys.right=false;
});

let pointerActive = false;
let pointerX = null;

function pDown(e){ pointerActive=true; pMove(e); startMusic(); }
function pUp(){ pointerActive=false; pointerX=null; }
function pMove(e){
  if (!pointerActive) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  pointerX = x / rect.width * W;
}

canvas.addEventListener("mousedown", pDown);
canvas.addEventListener("mouseup", pUp);
canvas.addEventListener("mouseleave", pUp);
canvas.addEventListener("mousemove", pMove);

canvas.addEventListener("touchstart", e=>{ e.preventDefault(); pDown(e);}, {passive:false});
canvas.addEventListener("touchend", e=>{ e.preventDefault(); pUp(e);}, {passive:false});
canvas.addEventListener("touchcancel", e=>{ e.preventDefault(); pUp(e);}, {passive:false});
canvas.addEventListener("touchmove", e=>{ e.preventDefault(); pMove(e);}, {passive:false});

canvas.addEventListener("click", ()=>{ if (gameOver) resetGame(); });
overlay.addEventListener("click", ()=>{ if (gameOver) resetGame(); });

// ---------------- ЛОГИКА ----------------
function update(dt) {
  if (gameOver) {
    if (isWin && celebrationFlakes.length) updateCelebration(dt);
    return;
  }

  // движение Федука
  if (keys.left)  player.x -= player.speed * dt;
  if (keys.right) player.x += player.speed * dt;

  if (pointerActive && pointerX !== null) {
    const target = pointerX - player.w/2;
    player.x += (target - player.x) * Math.min(1, dt * 10);
  }

  if (player.x < 0) player.x = 0;
  if (player.x + player.w > W) player.x = W - player.w;

  // спавн
  spawnTimer += dt;
  if (spawnTimer >= spawnInterval) {
    spawnTimer = 0;
    if (flakes.length < 20) spawnFlake();
    if (spawnInterval > 0.55) spawnInterval -= 0.005;
  }

  // обновление снежинок
  for (let i = flakes.length - 1; i >= 0; i--) {
    const f = flakes[i];

    // живость
    f.offset += f.wobbleSpeed * dt;
    f.x += Math.sin(f.offset) * f.amp * dt * 8;

    f.y -= f.speed * dt;

    const hitX = Math.abs(f.x - (player.x + player.w/2)) < (player.w/2);
    const hitY = f.y < player.y + player.h && f.y > player.y;

    if (hitX && hitY) {
      score++;
      flakes.splice(i,1);
      updateHUD();
      if (score >= WIN_SCORE) {
        gameOver = true;
        showOverlay(true);
      }
      continue;
    }

    if (f.y + f.r < -20) {
      flakes.splice(i,1);
      lives--;
      updateHUD();
      if (lives <= 0) {
        gameOver = true;
        showOverlay(false);
      }
    }
  }
}

// ---------------- ЦИКЛ ----------------
function loop(ts) {
  const dt = (ts - lastTime) / 1000 || 0;
  lastTime = ts;

  update(dt);

  ctx.clearRect(0,0,W,H);
  drawBG();
  drawFlakes(flakes);

  if (gameOver && isWin) drawFlakes(celebrationFlakes);

  drawPlayer();

  requestAnimationFrame(loop);
}

updateHUD();
showCenterHint();
requestAnimationFrame(loop);
</script>
</body>
</html>
